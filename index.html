<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verbalbeurteilungs-Assistent (Gemini Lokal mit Key-Eingabe)</title>
    <style>
:root {
    --primary-color: #60a38f;
    --primary-dark: #3d6358;
    --primary-light: #e4f2ee;
    --secondary-color: #6c757d;
    /* Stufenfarben für den Slider (Noten 1-6) */
    --level-1-color: #007bff; /* Sehr Gut (Blau) */
    --level-2-color: #28a745; /* Gut (Grün) */
    --level-3-color: #a2d5c6; /* Befriedigend (Helles Mintgrün) */
    --level-4-color: #ffc107; /* Ausreichend (Gelb) */
    --level-5-color: #fd7e14; /* Mangelhaft (Orange) */
    --level-6-color: #dc3545; /* Ungenügend (Rot) */

    --text-color: #212529;
    --light-text: #6c757d;
    --border-color: #dee2e6;
    --bg-color: #f8f9fa;
    --card-bg: #ffffff;
    --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    --border-radius: 0.3rem;
    --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-family);
    line-height: 1.6;
    color: var(--text-color);
    background-color: var(--bg-color);
    padding: 20px;
    position: relative; /* Für das Einstellungs-Icon */
}

/* Einstellungen Icon und Modal */
.settings-icon {
    position: fixed; /* Oder absolute, je nach Layout-Wunsch */
    top: 20px;
    right: 20px;
    font-size: 1.8rem;
    cursor: pointer;
    color: var(--primary-color);
    z-index: 1001; /* Über anderen Elementen */
    background-color: var(--card-bg);
    padding: 8px;
    border-radius: 50%;
    box-shadow: var(--box-shadow);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.settings-icon:hover {
    color: var(--primary-dark);
}

.modal {
    display: none; /* Standardmäßig versteckt */
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4); /* Dunkler Hintergrund */
}

.modal-content {
    background-color: var(--card-bg);
    margin: 15% auto;
    padding: 25px;
    border: 1px solid var(--border-color);
    width: 80%;
    max-width: 500px;
    border-radius: var(--border-radius);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
}

.modal-header {
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: var(--primary-color);
}

.close-button {
    color: var(--light-text);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-button:hover,
.close-button:focus {
    color: var(--text-color);
    text-decoration: none;
}

.modal-body .form-group {
    margin-bottom: 1.5rem;
}
.modal-body .form-label {
    font-weight: bold;
}
.modal-footer {
    text-align: right;
    margin-top: 20px;
}
.api-key-status {
    font-size: 0.9em;
    margin-top: 5px;
    color: var(--light-text);
}
.api-key-status.valid { color: var(--level-2-color); }
.api-key-status.invalid { color: var(--level-6-color); }


/* Restliches CSS bleibt gleich */
.container {
    max-width: 1140px;
    margin: 0 auto;
}

.header {
    text-align: center;
    margin-bottom: 35px;
    padding: 20px 0;
    border-bottom: 1px solid var(--border-color);
}

.header h1 {
    color: var(--primary-color);
    margin-bottom: 5px;
    font-size: 2.25rem;
    font-weight: 500;
}

.header__subtitle {
    color: var(--light-text);
    font-size: 1.1rem;
}

.card {
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
}

.card__header {
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.card__header h2 {
    color: var(--primary-color);
    margin: 0;
    font-size: 1.5rem;
    font-weight: 500;
}

.form-group {
    margin-bottom: 1.25rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-color);
}

.form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(96, 163, 143, 0.25);
}

.gender-options {
    display: flex;
    gap: 20px;
    margin-top: 0.5rem;
}

.radio-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.radio-option input[type="radio"] {
    width: 1.1rem;
    height: 1.1rem;
    cursor: pointer;
    accent-color: var(--primary-color);
}

.radio-label {
    font-size: 1rem;
}

.error-message-display {
    color: var(--level-6-color);
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: block;
}
.error-message-display.hidden { display: none; }

.category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.category-status {
    background-color: var(--primary-light);
    padding: 0.3rem 0.75rem;
    border-radius: 50rem;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--primary-dark);
}

.category-description {
    color: var(--light-text);
    font-style: italic;
    margin-bottom: 1.25rem;
    font-size: 0.9rem;
}

.traits-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.trait-item {
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 1.25rem;
    transition: box-shadow 0.2s ease-in-out;
    border: 1px solid var(--border-color);
}

.trait-item--active {
    border-left: 4px solid var(--primary-color);
    box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
}

.trait-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.trait-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    cursor: pointer;
    flex-grow: 1;
}

.trait-checkbox-label input[type="checkbox"] {
    width: 1.1rem;
    height: 1.1rem;
    cursor: pointer;
    accent-color: var(--primary-color);
}

.trait-name {
    font-weight: 500;
    font-size: 1.05rem;
    color: var(--text-color);
}

.trait-controls {
    margin-top: 1rem;
    padding-left: 1.7rem;
}
.trait-controls.hidden { display: none; }

.slider-container {
    margin-bottom: 0.75rem;
}

.slider {
    width: 100%;
    height: 0.5rem;
    border-radius: 0.25rem;
    outline: none;
    -webkit-appearance: none;
    background: linear-gradient(to right,
        var(--level-6-color) 0%, var(--level-6-color) 16.0%,
        var(--level-5-color) 16.7%, var(--level-5-color) 32.7%,
        var(--level-4-color) 33.4%, var(--level-4-color) 49.4%,
        var(--level-3-color) 50.1%, var(--level-3-color) 66.1%,
        var(--level-2-color) 66.8%, var(--level-2-color) 82.8%,
        var(--level-1-color) 83.5%, var(--level-1-color) 100%
    );
    cursor: pointer;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    background: var(--primary-color);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    margin-top: -0.375rem;
}

.slider::-moz-range-thumb {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    background: var(--primary-color);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.slider-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 0.375rem;
    font-size: 0.8rem;
    color: var(--light-text);
}

.trait-preview {
    background-color: var(--primary-light);
    padding: 0.75rem;
    border-radius: var(--border-radius);
    font-style: italic;
    color: var(--primary-dark);
    font-size: 0.9rem;
    min-height: 2.5rem;
    display: flex;
    align-items: center;
    border-left: 3px solid var(--primary-color);
}

.btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 400;
    transition: background-color 0.15s ease-in-out, transform 0.15s ease-in-out;
    margin-right: 0.5rem;
}

.btn:hover {
    background-color: var(--primary-dark);
    transform: translateY(-1px);
}
.btn:disabled {
    background-color: var(--secondary-color);
    cursor: not-allowed;
    opacity: 0.7;
}


.btn--secondary {
    background-color: var(--secondary-color);
    color: white;
}
.btn--secondary:hover {
    background-color: #5a6268;
}
.btn--secondary:disabled {
    background-color: #868e96;
}


.btn--primary.btn--sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.actions {
    text-align: center;
    margin: 1.5rem 0;
}

.validation-summary {
    padding: 0.75rem;
    margin-bottom: 1rem;
    border-radius: var(--border-radius);
    font-weight: 500;
    text-align: left;
    font-size: 0.9rem;
    border: 1px solid transparent;
}
.validation-summary.hidden { display: none; }
.validation-summary.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;}
.validation-summary.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb;}

.result-container {
    margin-top: 1.5rem;
}
.result-container.hidden { display: none; }

.result-text-area {
    width: 100%;
    background-color: #e9ecef;
    padding: 1rem;
    border-radius: var(--border-radius);
    line-height: 1.7;
    font-size: 1rem;
    font-family: inherit;
    min-height: 7.5rem;
    border: 1px solid var(--border-color);
    margin-bottom: 0.75rem;
    resize: vertical;
}

.footer {
    text-align: center;
    margin-top: 2.5rem;
    padding: 1rem 0;
    color: var(--light-text);
    border-top: 1px solid var(--border-color);
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    body { padding: 10px; }
    .settings-icon { top: 10px; right: 10px; font-size: 1.5rem; width: 35px; height: 35px; }
    .modal-content { margin: 10% auto; width: 90%;}
    .header h1 { font-size: 1.8rem; }
    .card { padding: 15px; }
    .btn { display: block; width: 100%; margin-bottom: 0.5rem; margin-right: 0; }
    .trait-controls { padding-left: 0; }
}
    </style>
</head>
<body>
    <!-- Settings Icon -->
    <div id="settings-icon" class="settings-icon" title="Einstellungen">
        ⚙️
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Einstellungen</h2>
                <span class="close-button" id="close-settings-modal">×</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="api-key-input" class="form-label">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="form-control" placeholder="Deinen API Key hier einfügen">
                    <p class="api-key-status" id="api-key-status">Kein API Key gespeichert.</p>
                    <small>Dein API Key wird nur lokal in deinem Browser gespeichert.</small>
                </div>
                <div class="form-group">
                    <label for="model-name-input" class="form-label">Gemini Modellname</label>
                    <input type="text" id="model-name-input" class="form-control" placeholder="z.B. gemini-1.5-flash-latest">
                     <small>Standard: gemini-1.5-flash-latest. Andere Modelle: gemini-pro, etc.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-settings-btn" class="btn btn--primary">Speichern</button>
            </div>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <h1>Verbalbeurteilungs-Assistent (Gemini Lokal)</h1>
            <p class="header__subtitle">Für Klassen 5/6 in Baden-Württemberg (V1.3 mit Key-Eingabe)</p>
        </div>
    </header>

    <main class="container main-content">
        <section class="student-info card">
            <div class="card__header">
                <h2>Schülerinformationen</h2>
            </div>
            <div class="card__body">
                <div class="form-group">
                    <label for="student-name" class="form-label">Name des Schülers/der Schülerin</label>
                    <input type="text" id="student-name" class="form-control" placeholder="Vor- und Nachname">
                    <div id="name-error" class="error-message-display hidden">Bitte geben Sie einen Namen ein.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Geschlecht</label>
                    <div class="gender-options">
                        <label class="radio-option">
                            <input type="radio" name="gender" value="male" id="gender-m">
                            <span class="radio-label">männlich</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="gender" value="female" id="gender-f">
                            <span class="radio-label">weiblich</span>
                        </label>
                    </div>
                    <div id="gender-error" class="error-message-display hidden">Bitte wählen Sie ein Geschlecht aus.</div>
                </div>
            </div>
        </section>

        <section class="assessment-categories">
            <!-- Categories and traits are dynamically inserted here by JavaScript -->
        </section>

        <section class="actions">
            <div class="validation-summary hidden" id="validation-summary"></div>
            <button id="generate-btn" class="btn btn--primary">Beurteilung generieren (Gemini)</button>
            <button id="reset-btn" class="btn btn--secondary">Eingaben zurücksetzen</button>
        </section>

        <section class="result-container card hidden" id="result-section">
            <div class="card__header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Generierte Beurteilung</h2>
                <button id="copy-btn" class="btn btn--primary btn--sm">
                    <span id="copy-text">Kopieren</span>
                </button>
            </div>
            <div class="card__body">
                <textarea id="result-text-area" class="result-text-area" placeholder="Die generierte Beurteilung erscheint hier..."></textarea>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p id="copyright-year">© Verbalbeurteilungs-Assistent</p>
        </div>
    </footer>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // Globale Variablen für Gemini Instanzen
        let genAI;
        let model;
        let currentApiKey = '';
        let currentModelName = 'gemini-1.5-flash-latest'; // Standardmodell

        const LOCAL_STORAGE_API_KEY = 'geminiApiKey';
        const LOCAL_STORAGE_MODEL_NAME = 'geminiModelName';


        // DOM Elemente für Einstellungen
        const settingsIcon = document.getElementById('settings-icon');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const modelNameInput = document.getElementById('model-name-input');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const apiKeyStatusEl = document.getElementById('api-key-status');


        function initializeGemini(apiKey, modelName) {
            if (!apiKey) {
                console.warn("Kein API Key für Gemini vorhanden.");
                if (apiKeyStatusEl) apiKeyStatusEl.textContent = "Kein API Key gespeichert. Bitte in den Einstellungen eingeben.";
                if (apiKeyStatusEl) apiKeyStatusEl.className = 'api-key-status invalid';
                model = null; // Sicherstellen, dass kein altes Modell verwendet wird
                return false;
            }
            try {
                genAI = new GoogleGenerativeAI(apiKey);
                model = genAI.getGenerativeModel({ model: modelName });
                currentApiKey = apiKey;
                currentModelName = modelName;
                console.log(`Gemini initialisiert mit Modell: ${modelName}`);
                if (apiKeyStatusEl) apiKeyStatusEl.textContent = `API Key aktiv (Modell: ${modelName}).`;
                if (apiKeyStatusEl) apiKeyStatusEl.className = 'api-key-status valid';
                return true;
            } catch (e) {
                console.error("Fehler bei der Initialisierung von Gemini:", e);
                if (apiKeyStatusEl) apiKeyStatusEl.textContent = "Fehler bei Initialisierung. Prüfen Sie API Key/Modell.";
                if (apiKeyStatusEl) apiKeyStatusEl.className = 'api-key-status invalid';
                model = null;
                return false;
            }
        }

        function loadSettings() {
            const storedApiKey = localStorage.getItem(LOCAL_STORAGE_API_KEY);
            const storedModelName = localStorage.getItem(LOCAL_STORAGE_MODEL_NAME) || 'gemini-1.5-flash-latest'; // Fallback

            if (apiKeyInput) apiKeyInput.value = storedApiKey || '';
            if (modelNameInput) modelNameInput.value = storedModelName;

            initializeGemini(storedApiKey, storedModelName);
        }

        function saveSettings() {
            const newApiKey = apiKeyInput.value.trim();
            const newModelName = modelNameInput.value.trim() || 'gemini-1.5-flash-latest'; // Fallback

            localStorage.setItem(LOCAL_STORAGE_API_KEY, newApiKey);
            localStorage.setItem(LOCAL_STORAGE_MODEL_NAME, newModelName);

            if (initializeGemini(newApiKey, newModelName)) {
                alert("Einstellungen gespeichert und Gemini initialisiert.");
                settingsModal.style.display = "none";
            } else {
                alert("API Key oder Modellname fehlerhaft. Gemini konnte nicht initialisiert werden.");
            }
        }

        // Event Listeners für Einstellungen
        if (settingsIcon) {
            settingsIcon.onclick = () => {
                if (settingsModal) settingsModal.style.display = "block";
                 // Lade aktuelle Werte beim Öffnen, falls sie extern geändert wurden (unwahrscheinlich hier)
                const storedApiKey = localStorage.getItem(LOCAL_STORAGE_API_KEY);
                const storedModelName = localStorage.getItem(LOCAL_STORAGE_MODEL_NAME) || 'gemini-1.5-flash-latest';
                if (apiKeyInput) apiKeyInput.value = storedApiKey || '';
                if (modelNameInput) modelNameInput.value = storedModelName;
                if (apiKeyStatusEl) { // Status aktualisieren
                     if (storedApiKey) {
                        apiKeyStatusEl.textContent = `API Key aktiv (Modell: ${storedModelName}).`;
                        apiKeyStatusEl.className = 'api-key-status valid';
                    } else {
                        apiKeyStatusEl.textContent = "Kein API Key gespeichert.";
                        apiKeyStatusEl.className = 'api-key-status invalid';
                    }
                }
            };
        }
        if (closeSettingsModalBtn) {
            closeSettingsModalBtn.onclick = () => {
                if (settingsModal) settingsModal.style.display = "none";
            };
        }
        if (saveSettingsBtn) {
            saveSettingsBtn.onclick = saveSettings;
        }
        // Schließen, wenn außerhalb geklickt wird
        window.onclick = (event) => {
            if (event.target == settingsModal) {
                settingsModal.style.display = "none";
            }
        };


        const CATEGORY_KEYS = {
            ARBEITSHALTUNG: "Arbeitshaltung",
            SELBSTSTAENDIGKEIT: "Selbstständigkeit",
            SOZIALVERHALTEN: "Sozial- und Kooperationsverhalten"
        };
        const categoryOrder = [CATEGORY_KEYS.ARBEITSHALTUNG, CATEGORY_KEYS.SELBSTSTAENDIGKEIT, CATEGORY_KEYS.SOZIALVERHALTEN];

        const SHARED_LEVEL_LABELS = {
            1: "Sehr gut",
            2: "Gut",
            3: "Befriedigend",
            4: "Ausreichend",
            5: "Mangelhaft",
            6: "Ungenügend"
        };

        const assessmentTraits = { // Deine assessmentTraits Definition bleibt hier gleich...
            [CATEGORY_KEYS.ARBEITSHALTUNG]: {
                name: "Arbeitshaltung",
                description: "Motivation, Ausdauer und Konzentration",
                traits: [
                    { id: 'fleiss_ansatz', label: 'Motivation & Aufgabenbeginn', default: 3,
                        levels: {
                            6: "zeigt auch nach mehrfacher Aufforderung kaum Bereitschaft, mit Aufgaben zu beginnen",
                            5: "beginnt mit Aufgaben oft erst nach wiederholter Aufforderung und wirkt dabei wenig motiviert",
                            4: "benötigt häufiger einen Anstoß, um mit einer Aufgabe zu beginnen",
                            3: "beginnt nach der Aufgabenstellung in der Regel zügig und angemessen motiviert mit der Arbeit",
                            2: "greift neue Aufgaben bereitwillig auf und beginnt zügig mit deren Bearbeitung",
                            1: "zeigt eine hohe Eigenmotivation und beginnt stets umgehend und zielgerichtet mit neuen Aufgaben"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'fleiss_durchfuehrung', label: 'Anstrengungsbereitschaft', default: 3,
                        levels: {
                            6: "verweigert häufig die Bearbeitung von Aufgaben oder bricht bei ersten Schwierigkeiten sofort ab",
                            5: "zeigt bei der Bearbeitung von Aufgaben nur geringe Ausdauer und gibt bei Schwierigkeiten schnell auf",
                            4: "arbeitet bei einfachen Aufgaben ausdauernd, bei größeren Herausforderungen lässt die Anstrengung jedoch nach",
                            3: "zeigt eine im Allgemeinen gute Ausdauer und bearbeitet die gestellten Aufgaben bis zum Ende",
                            2: "arbeitet konzentriert und ausdauernd an Aufgaben und lässt sich auch von Schwierigkeiten nicht entmutigen",
                            1: "zeigt eine vorbildliche Anstrengungsbereitschaft und Ausdauer, auch bei komplexen und langwierigen Aufgaben"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'sorgfalt_material', label: 'Umgang mit Material', default: 3, defaultChecked: false,
                        levels: {
                            6: "geht durchweg sehr unachtsam und oft zerstörerisch mit Arbeitsmaterialien um",
                            5: "geht oft unachtsam mit Arbeitsmaterialien um und muss häufiger ermahnt werden",
                            4: "sollte noch sorgsamer mit {sein_ihr}en Arbeitsmaterialien umgehen",
                            3: "geht in der Regel sorgfältig mit {sein_ihr}en Arbeitsmaterialien um",
                            2: "geht gut und ordentlich mit {sein_ihr}en Arbeitsmaterialien um",
                            1: "geht stets vorbildlich sorgfältig und verantwortungsbewusst mit Arbeitsmaterialien um"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'sorgfalt_ausfuehrung', label: 'Genauigkeit der Ausführung', default: 3,
                        levels: {
                            6: "arbeitet durchweg flüchtig und mit vielen Fehlern",
                            5: "arbeitet häufig mit mangelnder Genauigkeit bei Aufgaben",
                            4: "arbeitet bei der Ausführung oft noch nicht durchgängig genau",
                            3: "erledigt Aufgaben mit einer im Großen und Ganzen angemessenen Genauigkeit",
                            2: "erledigt Aufgaben mit guter Genauigkeit",
                            1: "zeichnet sich durch eine sehr genaue und sorgfältige Arbeitsweise aus"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'ausdauer_konzentration', label: 'Konzentrationsfähigkeit', default: 3,
                        levels: {
                            6: "kann sich auch bei kurzen Aufgaben kaum konzentrieren",
                            5: "hat deutliche Schwierigkeiten, sich länger zu konzentrieren",
                            4: "kann die Konzentration oft nur für eine kurze Zeitspanne aufrechterhalten",
                            3: "zeigt eine dem Alter angemessene Konzentrationsspanne",
                            2: "kann sich auch bei längeren Aufgaben gut konzentrieren",
                            1: "kann auch über längere Phasen sehr konzentriert und fokussiert arbeiten"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'ausdauer_ablenkung', label: 'Umgang mit Ablenkungen', default: 3,
                        levels: {
                            6: "lässt sich ständig ablenken und stört dabei auch andere",
                            5: "lässt sich sehr leicht ablenken und findet schwer zur Aufgabe zurück",
                            4: "lässt sich noch oft von äußeren Reizen ablenken, findet aber zumeist zur Aufgabe zurück",
                            3: "lässt sich nur gelegentlich ablenken und kann sich dann wieder auf die Arbeit fokussieren",
                            2: "lässt sich kaum von äußeren Reizen ablenken",
                            1: "lässt sich auch bei Störungen kaum von der Tätigkeit abbringen und arbeitet unbeirrt weiter"
                        }, levelLabels: SHARED_LEVEL_LABELS }
                ]
            },
            [CATEGORY_KEYS.SELBSTSTAENDIGKEIT]: {
                name: "Selbstständigkeit",
                description: "Organisation und Eigeninitiative",
                traits: [
                    { id: 'eigeninitiative_ideen', label: 'Ideenfindung', default: 3,
                        levels: {
                            6: "zeigt keinerlei Eigeninitiative und beteiligt sich nicht an der Ideenfindung",
                            5: "zeigt selten Eigeninitiative bei der Ideenfindung",
                            4: "bringt sich noch selten mit eigenen Ideen ein, greift aber Anregungen auf",
                            3: "bringt gelegentlich eigene, passende Ideen in den Unterricht ein",
                            2: "bringt oft gute eigene Ideen ein und sucht nach kreativen Lösungswegen",
                            1: "zeichnet sich durch hohe Eigeninitiative bei der Ideenfindung und kreative Ansätze aus"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'eigeninitiative_umsetzung', label: 'Selbstständige Umsetzung', default: 3, defaultChecked: false,
                        levels: {
                            6: "benötigt bei jedem Schritt detaillierte Anleitung und Kontrolle",
                            5: "wartet meist auf detaillierte Anweisungen, bevor {er_sie} tätig wird",
                            4: "benötigt noch oft Anleitung, um Aufgaben eigenständig umzusetzen",
                            3: "setzt Aufgaben nach einer Anleitung in der Regel selbstständig um",
                            2: "setzt Ideen engagiert und selbstständig um",
                            1: "setzt Ideen eigenverantwortlich und zielgerichtet um"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'verantwortung_material_termine', label: 'Organisation', default: 3,
                        levels: {
                            6: "vergisst Materialien und Termine durchgängig und zeigt kein Bemühen um Besserung",
                            5: "zeigt erhebliche Nachlässigkeit im Umgang mit Material und Terminen",
                            4: "muss noch zuverlässiger auf {sein_ihr}e Materialien und Termine achten",
                            3: "achtet meist auf die Vollständigkeit {sein_ihr}er Materialien und die Einhaltung von Terminen",
                            2: "geht verantwortungsvoll mit Materialien um und hält Termine zuverlässig ein",
                            1: "zeigt große Zuverlässigkeit und Sorgfalt im Umgang mit Materialien und Terminen"
                        }, levelLabels: SHARED_LEVEL_LABELS }
                ]
            },
            [CATEGORY_KEYS.SOZIALVERHALTEN]: {
                name: "Sozial- und Kooperationsverhalten",
                description: "Teamfähigkeit, Kommunikation und Regelverhalten",
                traits: [
                    { id: 'kooperation_teamarbeit', label: 'Einbringen in Teamarbeit', default: 3,
                        levels: {
                            6: "verweigert häufig die Zusammenarbeit oder stört Gruppenprozesse erheblich",
                            5: "hält sich in Teamarbeit oft zurück oder beteiligt sich nur passiv",
                            4: "sollte sich noch aktiver und konstruktiver in Gruppenprozesse einbringen",
                            3: "arbeitet in der Regel kooperativ und konstruktiv in Gruppen mit",
                            2: "zeigt sich als kooperatives und geschätztes Mitglied in Arbeitsgruppen",
                            1: "bringt sich stets konstruktiv, engagiert und rücksichtsvoll in Teams ein"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'kooperation_regeln', label: 'Einhaltung von Regeln', default: 3,
                        levels: {
                            6: "missachtet Regeln häufig und bewusst",
                            5: "beachtet Absprachen und Regeln oft nicht und benötigt häufige Ermahnungen",
                            4: "muss noch konsequenter auf gemeinsame Regeln und Absprachen achten",
                            3: "hält sich im Allgemeinen an getroffene Absprachen und Regeln",
                            2: "achtet auf die Einhaltung von Gruppenregeln und Absprachen",
                            1: "achtet vorbildlich auf Regeln und unterstützt andere dabei"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'hilfsbereitschaft_angebot', label: 'Hilfe anbieten', default: 3,
                        levels: {
                            6: "zeigt keinerlei Hilfsbereitschaft und verhält sich oft egoistisch",
                            5: "zeigt selten von sich aus Hilfsbereitschaft",
                            4: "könnte noch häufiger von sich aus Hilfe anbieten und auf andere zugehen",
                            3: "ist hilfsbereit, wenn {er_sie} um Unterstützung gebeten wird",
                            2: "bietet Mitschülern bereitwillig und oft unaufgefordert Hilfe an",
                            1: "zeichnet sich durch große Hilfsbereitschaft und ein ausgeprägtes Einfühlungsvermögen aus"
                        }, levelLabels: SHARED_LEVEL_LABELS },
                    { id: 'einfuehlungsvermoegen_verhalten', label: 'Einfühlungsvermögen', default: 3,
                        levels: {
                            6: "zeigt keinerlei Einfühlungsvermögen und reagiert oft unangemessen auf andere",
                            5: "zeigt kaum Einfühlungsvermögen in die Belange anderer",
                            4: "sollte noch lernen, die Bedürfnisse und Gefühle anderer besser wahrzunehmen",
                            3: "zeigt grundlegendes Einfühlungsvermögen in die Situation anderer",
                            2: "zeigt gutes Einfühlungsvermögen für die Anliegen und Gefühle anderer",
                            1: "geht stets sehr einfühlsam und verständnisvoll auf {sein_ihr}e Mitschüler ein"
                        }, levelLabels: SHARED_LEVEL_LABELS }
                ]
            }
        };


        let studentNameEl, genderRadioEls, resetBtnEl, copyBtnEl, generateBtnEl;
        let validationSummaryEl, resultSectionEl, resultTextEl;
        let categoryContainerEl;
        let selectedTraitsData = {};

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            loadSettings(); // Lade API Key beim Start
        });

        function initializeApp() {
            studentNameEl = document.getElementById('student-name');
            genderRadioEls = document.querySelectorAll('input[name="gender"]');
            resetBtnEl = document.getElementById('reset-btn');
            copyBtnEl = document.getElementById('copy-btn');
            generateBtnEl = document.getElementById('generate-btn');
            validationSummaryEl = document.getElementById('validation-summary');
            resultSectionEl = document.getElementById('result-section');
            resultTextEl = document.getElementById('result-text-area');
            categoryContainerEl = document.querySelector('.assessment-categories');

            renderCategoriesAndTraits();
            addEventListeners();
            updateAllCategoryCounters();

            const currentYear = new Date().getFullYear();
            const copyrightYearEl = document.getElementById('copyright-year');
            if (copyrightYearEl) {
                copyrightYearEl.textContent = `© ${currentYear} Verbalbeurteilungs-Assistent`;
            }
        }
        
        function renderCategoriesAndTraits() {
            categoryContainerEl.innerHTML = '';
            selectedTraitsData = {};

            categoryOrder.forEach(catKey => {
                const categoryData = assessmentTraits[catKey];
                selectedTraitsData[catKey] = {};

                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'category-wrapper';

                const categoryCard = document.createElement('div');
                categoryCard.className = 'category card';
                categoryCard.id = catKey.toLowerCase().replace(/\s+/g, '-');

                categoryCard.innerHTML = `
                    <div class="card__header category-header">
                        <h2>${categoryData.name}</h2>
                        <div class="category-status">
                            <span id="${catKey}-count">0</span>/${categoryData.traits.length} ausgewählt
                        </div>
                    </div>
                    <div class="card__body">
                        <p class="category-description">${categoryData.description}</p>
                        <div class="traits-list"></div>
                    </div>
                `;
                categoryWrapper.appendChild(categoryCard);
                categoryContainerEl.appendChild(categoryWrapper);

                const traitsListEl = categoryCard.querySelector('.traits-list');
                categoryData.traits.forEach(trait => {
                    const defaultNote = trait.default;
                    const defaultSliderValue = 7 - defaultNote;

                    const traitItemEl = document.createElement('div');
                    traitItemEl.className = 'trait-item';
                    traitItemEl.innerHTML = `
                        <div class="trait-header">
                            <label class="trait-checkbox-label">
                                <input type="checkbox" data-category-key="${catKey}" data-trait-id="${trait.id}">
                                <span class="trait-name">${trait.label}</span>
                            </label>
                        </div>
                        <div class="trait-controls hidden">
                            <div class="slider-container">
                                <input type="range" min="1" max="6" value="${defaultSliderValue}" class="slider"
                                       data-category-key="${catKey}" data-trait-id="${trait.id}">
                                <div class="slider-labels">
                                    ${Object.keys(SHARED_LEVEL_LABELS).sort((a, b) => b - a).map(level => `<span>${level}</span>`).join('')}
                                </div>
                            </div>
                            <div class="trait-preview"></div>
                        </div>
                    `;
                    traitsListEl.appendChild(traitItemEl);

                    const checkbox = traitItemEl.querySelector('input[type="checkbox"]');
                    const controls = traitItemEl.querySelector('.trait-controls');

                    const isCheckedByDefault = trait.defaultChecked !== false;
                    checkbox.checked = isCheckedByDefault;

                    if (isCheckedByDefault) {
                        controls.classList.remove('hidden');
                        traitItemEl.classList.add('trait-item--active');
                        selectedTraitsData[catKey][trait.id] = defaultNote;
                        updateTraitPreview(catKey, trait.id, defaultNote);
                    }
                });
            });
        }

        function addEventListeners() {
            studentNameEl.addEventListener('input', updateAllPreviews);
            genderRadioEls.forEach(radio => radio.addEventListener('change', updateAllPreviews));

            categoryContainerEl.addEventListener('change', function(event) {
                if (event.target.matches('input[type="checkbox"][data-category-key]')) {
                    handleTraitCheckboxChange(event);
                }
            });
            categoryContainerEl.addEventListener('input', function(event) {
                if (event.target.matches('input[type="range"][data-category-key]')) {
                    handleSliderChange(event);
                }
            });

            if (generateBtnEl) {
                generateBtnEl.addEventListener('click', handleGenerateButtonClick);
            }
            resetBtnEl.addEventListener('click', resetForm);
            copyBtnEl.addEventListener('click', copyToClipboard);
        }

        function updateAllPreviews() {
            categoryOrder.forEach(catKey => {
                const categoryData = assessmentTraits[catKey];
                const selectedInCategory = selectedTraitsData[catKey] || {};
                categoryData.traits.forEach(trait => {
                    if (selectedInCategory.hasOwnProperty(trait.id)) {
                        updateTraitPreview(catKey, trait.id, selectedInCategory[trait.id]);
                    } else {
                        const slider = document.querySelector(`input[type="range"][data-category-key="${catKey}"][data-trait-id="${trait.id}"]`);
                        if (slider) {
                           const previewEl = slider.closest('.trait-item').querySelector('.trait-preview');
                           if (previewEl) previewEl.textContent = '';
                        }
                    }
                });
            });
        }

        function handleTraitCheckboxChange(event) {
            const checkbox = event.target;
            const catKey = checkbox.dataset.categoryKey;
            const traitId = checkbox.dataset.traitId;
            const traitItemEl = checkbox.closest('.trait-item');
            const controls = traitItemEl.querySelector('.trait-controls');

            if (checkbox.checked) {
                controls.classList.remove('hidden');
                traitItemEl.classList.add('trait-item--active');
                const slider = controls.querySelector('input[type="range"]');
                const sliderValue = parseInt(slider.value);
                const noteValue = 7 - sliderValue;
                selectedTraitsData[catKey][traitId] = noteValue;
                updateTraitPreview(catKey, traitId, noteValue);
            } else {
                controls.classList.add('hidden');
                traitItemEl.classList.remove('trait-item--active');
                delete selectedTraitsData[catKey][traitId];
                const preview = controls.querySelector('.trait-preview');
                preview.textContent = '';
            }
            updateCategoryCounter(catKey);
        }

        function handleSliderChange(event) {
            const slider = event.target;
            const catKey = slider.dataset.categoryKey;
            const traitId = slider.dataset.traitId;
            const sliderValue = parseInt(slider.value);
            const noteValue = 7 - sliderValue;

            if (selectedTraitsData[catKey] && selectedTraitsData[catKey].hasOwnProperty(traitId)) {
                 selectedTraitsData[catKey][traitId] = noteValue;
                 updateTraitPreview(catKey, traitId, noteValue);
            }
        }

        function updateTraitPreview(catKey, traitId, noteValue) {
            const traitData = assessmentTraits[catKey].traits.find(t => t.id === traitId);
            if (!traitData) return;

            let phrase = traitData.levels[noteValue];
            const studentName = studentNameEl.value.trim();
            const genderValue = document.querySelector('input[name="gender"]:checked')?.value;

            let pronounsForPreview = {};
            if (genderValue) {
                pronounsForPreview = getPronouns(genderValue);
            }
            phrase = personalizeText(phrase, studentName || "{Name}", pronounsForPreview);

            const sliderEl = document.querySelector(`input[type="range"][data-category-key="${catKey}"][data-trait-id="${traitId}"]`);
            if (sliderEl) {
                const previewEl = sliderEl.closest('.trait-item').querySelector('.trait-preview');
                if (previewEl) {
                    previewEl.textContent = `"... ${phrase}"`;
                }
            }
        }

        function updateCategoryCounter(catKey) {
            const count = Object.keys(selectedTraitsData[catKey] || {}).length;
            const counterEl = document.getElementById(`${catKey}-count`);
            if (counterEl) {
                counterEl.textContent = count;
            }
        }
        function updateAllCategoryCounters() {
            categoryOrder.forEach(catKey => updateCategoryCounter(catKey));
        }

        function validateAllInputs() {
            let isValid = true;
            const errors = [];

            const nameErrorEl = document.getElementById('name-error');
            if (!studentNameEl.value.trim()) {
                nameErrorEl.textContent = 'Bitte geben Sie einen Namen ein.';
                nameErrorEl.classList.remove('hidden');
                isValid = false;
                errors.push('Schülername fehlt');
            } else {
                nameErrorEl.classList.add('hidden');
            }

            const genderErrorEl = document.getElementById('gender-error');
            const selectedGender = document.querySelector('input[name="gender"]:checked');
            if (!selectedGender) {
                genderErrorEl.textContent = 'Bitte wählen Sie ein Geschlecht aus.';
                genderErrorEl.classList.remove('hidden');
                isValid = false;
                errors.push('Geschlecht nicht ausgewählt');
            } else {
                genderErrorEl.classList.add('hidden');
            }

            let totalSelectedTraits = 0;
            categoryOrder.forEach(catKey => {
                totalSelectedTraits += Object.keys(selectedTraitsData[catKey] || {}).length;
            });
            if (totalSelectedTraits === 0) {
                isValid = false;
                errors.push("Bitte wählen Sie mindestens einen Aspekt für die Beurteilung aus.");
            }

            if (!isValid && errors.length > 0) {
                validationSummaryEl.innerHTML = `<strong>Bitte korrigieren Sie:</strong><br>• ${errors.join('<br>• ')}`;
                validationSummaryEl.className = 'validation-summary error';
            } else if (isValid) {
                 validationSummaryEl.className = 'validation-summary success';
                 validationSummaryEl.innerHTML = `Alle Eingaben sind gültig.`;
            } else {
                 validationSummaryEl.className = 'validation-summary error';
                 validationSummaryEl.innerHTML = `Bitte überprüfen Sie Ihre Auswahl. Mindestens ein Aspekt muss ausgewählt sein.`;
            }
            validationSummaryEl.classList.remove('hidden');
            return isValid;
        }

        function getPronouns(genderValue) {
            if (genderValue === 'male') {
                return { "{er_sie}": "er", "{sein_ihr}": "sein", "{ihn_sie}": "ihn", "{ihm_ihr}": "ihm", "{Respektpronomen}": "er", "{Er_Sie}": "Er", "{Sein_Ihr}": "Sein"};
            } else {
                return { "{er_sie}": "sie", "{sein_ihr}": "ihr", "{ihn_sie}": "sie", "{ihm_ihr}": "ihr", "{Respektpronomen}": "sie", "{Er_Sie}": "Sie", "{Sein_Ihr}": "Ihr"};
            }
        }

        function personalizeText(text, studentName, pronouns) {
            if (!text) return "";
            let personalized = text;
            personalized = personalized.replace(/{Name}/g, studentName || "{Name}");
            for (const placeholder in pronouns) {
                personalized = personalized.replace(new RegExp(placeholder.replace(/([\{\}])/g, "\\$1"), 'g'), pronouns[placeholder]);
            }
            return personalized;
        }

        function collectAssessmentData() {
            const studentName = studentNameEl.value.trim();
            const genderValue = document.querySelector('input[name="gender"]:checked')?.value;

            const data = {
                studentName: studentName,
                gender: genderValue,
                selectedTraits: []
            };

            categoryOrder.forEach(catKey => {
                const categoryData = assessmentTraits[catKey];
                categoryData.traits.forEach(trait => {
                    const checkbox = document.querySelector(`input[type="checkbox"][data-category-key="${catKey}"][data-trait-id="${trait.id}"]`);
                    if (checkbox && checkbox.checked) {
                        if (selectedTraitsData[catKey] && selectedTraitsData[catKey].hasOwnProperty(trait.id)) {
                            const noteValue = selectedTraitsData[catKey][trait.id];
                            const levelLabel = SHARED_LEVEL_LABELS[noteValue] || `Note ${noteValue}`;
                            data.selectedTraits.push({
                                category: categoryData.name,
                                traitLabel: trait.label,
                                note: noteValue,
                                noteText: levelLabel,
                            });
                        }
                    }
                });
            });
            return data;
        }


        async function handleGenerateButtonClick() {
            if (!model) { // Prüft, ob das Gemini Modell initialisiert wurde
                alert("Gemini AI ist nicht korrekt initialisiert. Bitte geben Sie einen gültigen API Key in den Einstellungen ein.");
                resultTextEl.value = "Fehler: Gemini AI nicht initialisiert. API-Key in Einstellungen prüfen.";
                if (settingsModal) settingsModal.style.display = "block"; // Modal direkt öffnen
                return;
            }

            const isValid = validateAllInputs();
            if (!isValid) {
                resultTextEl.value = "Bitte korrigieren Sie die Eingabefehler.";
                resultSectionEl.classList.remove('hidden');
                return;
            }

            const assessmentData = collectAssessmentData();

            if (assessmentData.selectedTraits.length === 0) {
                validationSummaryEl.innerHTML = `Bitte wählen Sie mindestens einen Aspekt für die Beurteilung aus.`;
                validationSummaryEl.className = 'validation-summary error';
                validationSummaryEl.classList.remove('hidden');
                resultTextEl.value = "Keine Aspekte für die Beurteilung ausgewählt.";
                resultSectionEl.classList.remove('hidden');
                return;
            }
            validationSummaryEl.classList.add('hidden');

            resultTextEl.value = "Beurteilung wird von Gemini generiert, bitte warten...";
            resultSectionEl.classList.remove('hidden');
            generateBtnEl.disabled = true;
            copyBtnEl.disabled = true;

            try {
                let prompt = `Erstelle eine kurze und prägnante Verbalbeurteilung für ${assessmentData.gender === 'male' ? 'einen Schüler' : 'eine Schülerin'} der 5./6. Klasse in Baden-Württemberg.\n`;
                prompt += `Der Text soll die Kernaspekte klar und verständlich wiedergeben, ohne an Kohärenz zu verlieren, und dabei relativ kurz bleiben.\n\n`;
                prompt += `Name: ${assessmentData.studentName}\n`;
                prompt += `Geschlecht: ${assessmentData.gender === 'male' ? 'männlich' : 'weiblich'}\n\n`;
                prompt += `Folgende Aspekte wurden bewertet (Skala 1=Sehr gut bis 6=Ungenügend):\n`;

                assessmentData.selectedTraits.forEach(trait => {
                    prompt += `- Kategorie "${trait.category}", Aspekt "${trait.traitLabel}": ${trait.noteText} (Note ${trait.note})\n`;
                });

                prompt += `\nFormuliere die Beurteilung als zusammenhängenden Text in ganzen Sätzen. `;
                prompt += `Verwende Pronomen passend zum Geschlecht. `;
                prompt += `Der Text soll für ein Zeugnis geeignet sein und eine positive, pädagogisch wertvolle Tonalität haben. `;
                prompt += `Beginne direkt mit der Beurteilung ohne einleitende Floskeln wie "Hier ist die Beurteilung:".`;

                console.log("Gemini Prompt:", prompt);

                const result = await model.generateContent(prompt); // Nutzt das global initialisierte `model`
                const response = await result.response;
                const text = response.text();

                resultTextEl.value = text;

            } catch (error) {
                console.error('Fehler beim Generieren der Beurteilung (Gemini API):', error);
                let errorMessage = `Fehler bei der Kommunikation mit der Gemini API.`;
                 if (error && error.message) {
                    errorMessage += ` Details: ${error.message}`;
                    if (error.message.includes("API key not valid") || (error.toString && error.toString().includes("API key not valid")) || error.message.includes("permission denied")) {
                        errorMessage = "Der Gemini API-Schlüssel ist ungültig, nicht korrekt konfiguriert oder hat keine Berechtigung. Bitte überprüfen Sie ihn in den Einstellungen.";
                        if (settingsModal) settingsModal.style.display = "block";
                    } else if (error.message.includes("quota") || (error.toString && error.toString().includes("quota"))) {
                        errorMessage = "Das API-Kontingent wurde überschritten. Bitte versuchen Sie es später erneut oder überprüfen Sie Ihr Google Cloud Projekt.";
                    } else if (error.message.includes("Invalid JSON payload") || (error.toString && error.toString().includes("Invalid JSON payload"))) {
                         errorMessage = "Fehler im Anfrageformat an Gemini. Bitte kontaktieren Sie den Entwickler.";
                    } else if (error.message.includes("fetch") && error.message.toLowerCase().includes("failed to fetch")) {
                        errorMessage = "Netzwerkfehler oder CORS-Problem. Stellen Sie sicher, dass eine Internetverbindung besteht und der API-Endpunkt erreichbar ist. (Lokale Datei: Dies sollte nicht passieren, prüfen Sie die Konsole auf detailliertere Fehler)";
                    }
                } else if (error && error.toString) {
                     errorMessage += ` Details: ${error.toString()}`;
                }
                resultTextEl.value = errorMessage;
            } finally {
                generateBtnEl.disabled = false;
                copyBtnEl.disabled = false;
            }
        }

        function copyToClipboard() {
            const textToCopy = resultTextEl.value;
            if (navigator.clipboard && textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const copyTextSpan = document.getElementById('copy-text');
                    const originalText = copyTextSpan.textContent;
                    copyTextSpan.textContent = 'Kopiert!';
                    setTimeout(() => {
                        copyTextSpan.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Fehler beim Kopieren:', err);
                    alert("Fehler beim Kopieren.");
                });
            } else if (textToCopy) {
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    const copyTextSpan = document.getElementById('copy-text');
                    const originalText = copyTextSpan.textContent;
                    copyTextSpan.textContent = 'Kopiert!';
                    setTimeout(() => {
                        copyTextSpan.textContent = originalText;
                    }, 2000);
                } catch (err) {
                    console.error('Fallback-Kopierfehler:', err);
                    alert("Fehler beim Kopieren (Fallback).");
                }
                document.body.removeChild(textarea);
            }
        }

        function resetForm() {
            studentNameEl.value = '';
            genderRadioEls.forEach(radio => radio.checked = false);

            renderCategoriesAndTraits();
            updateAllCategoryCounters();
            resultTextEl.value = '';
            resultSectionEl.classList.add('hidden');
            validationSummaryEl.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
